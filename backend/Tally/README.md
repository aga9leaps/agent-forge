
# Magic Paints Tally Integration - Backend

This backend project automates Tally report generation, uploads reports to AWS S3, and supports scheduled tasks via a Windows service.

## Setup

### 1. Prerequisites

- **Node.js** (v18+ recommended)
- **npm** (Node package manager)
- **Tally Prime** running and accessible (for report data)
- **AWS S3** bucket and credentials

### 2. Install Dependencies

```bash
cd backend/Tally
npm install
```

### 3. Environment Configuration
Create a .env file in backend/configs/ (or as referenced in your scripts):
```bash
AWS_REGION=your-aws-region
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
TALLY_AWS_BUCKET_NAME=your-s3-bucket
TALLY_URL=http://localhost:your-ODBC-port
```
Adjust the path in your scripts if your .env is elsewhere.

## Usage
### 1. Run Reports Manually
Navigate to the TallyReports folder and run any report script:
```bash
node TallyReports/BillsPayableReport.js
node TallyReports/MasterReport.js
node TallyReports/VoucherRegisterReport.js
```
### 2. Scheduled Reports
Configure schedules in cron-config.json.
The cron_scheduler.js script reads this config and runs the specified reports at the defined times.
To start the scheduler manually:
```bash
node cron_scheduler.js
```
### 3. Run as a Windows Service
The service will run the scheduler in the background on Windows.

**Install the Service**
```bash 
node service.js --install
```
This uses node-windows to install a service named "Tally Reports Service".
Logs and binaries are stored in the daemon/ folder.

**Uninstall the Service**

To uninstall the service, run:
```bash
node service.js --uninstall
```

This allows you to install with `node service.js --install` and uninstall with `node service.js --uninstall`.

## File Descriptions

- **cron_scheduler.js**: Loads `cron-config.json`, downloads scripts/configs from S3, and schedules report generation.
- **s3Utils.js**: Handles AWS S3 file uploads/downloads.
- **service.js**: Installs the scheduler as a Windows service (requires Node.js CommonJS or dynamic import workaround).
- **TallyReports/***: Individual scripts for generating and uploading specific Tally reports.
- **master_ledger_response.json**: Output file generated by `MasterReport.js` to store `Party_Address` column in `VoucherRegistereport.js`.

## Development Notes
All scripts are written as ES modules ("type": "module" in package.json).
For scripts using require (like node-windows), use .cjs extension or dynamic import.

## Troubleshooting
- **Environment Variables Not Loaded**: Ensure .env is in the correct path and loaded before any AWS SDK or config usage.
- **Path Issues on Windows**: Paths are normalized in scripts, but if you see double C:\C:\..., check the path logic.
- **AWS SDK v2 Warning**: Consider migrating to AWS SDK v3 for long-term support.
- **Tally Connection**: Ensure Tally is running and accessible at the URL specified in your .env.

